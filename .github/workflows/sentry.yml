name: Process New Target

on:
  issues:
    types: [opened]

jobs:
  add-target:
    if: contains(github.event.issue.title, 'ADD_TARGET')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v3

      - name: Parse Issue & Update Database
        id: update
        run: |
          # 1. Get the JSON body from the issue
          echo "${{ github.event.issue.body }}" > new_target.json
          
          # 2. Use Python to append it to targets.json
          python3 -c "
          import json, os
          with open('new_target.json', 'r') as f:
              new_t = json.load(f)
          
          targets = []
          if os.path.exists('targets.json'):
              with open('targets.json', 'r') as f:
                  targets = json.load(f)
                  
          # Avoid duplicates
          if not any(t['id'] == new_t['id'] for t in targets):
              targets.append(new_t)
              
          with open('targets.json', 'w') as f:
              json.dump(targets, f, indent=2)
          "
          
          # 3. Cleanup
          rm new_target.json

      - name: Commit Changes
        run: |
          git config --global user.name "Command Bot"
          git config --global user.email "bot@satellite.com"
          git add targets.json
          git commit -m "ðŸŽ¯ New Target Acquired: ${{ github.event.issue.title }}"
          git push

      - name: Trigger Scan
        # This triggers the main deploy workflow to run IMMEDIATELY
        run: gh workflow run deploy.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close Issue
        run: gh issue close ${{ github.event.issue.number }} --comment "âœ… Target Acquired. Satellite tasking initiated."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
